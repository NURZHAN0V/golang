# 2.2 –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ: `pprof` –∏ `trace`

> –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, **–≥–¥–µ** —Ç—Ä–∞—Ç–∏—Ç—Å—è –≤—Ä–µ–º—è –∏ –ø–∞–º—è—Ç—å. –í Go –≤—Å—Ç—Ä–æ–µ–Ω –ø–∞–∫–µ—Ç `runtime/pprof` –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç `go tool pprof`, –ø–ª—é—Å —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ `go tool trace`.

## 1. –ë—ã—Å—Ç—Ä—ã–π start: `go test -bench` + pprof
```bash
go test -bench=. -benchmem -cpuprofile cpu.out -memprofile mem.out
```
–ö–ª—é—á–∏:
* `-cpuprofile` ‚Äì –∑–∞–ø–∏—Å—å CPU –ø—Ä–æ—Ñ–∏–ª—è.
* `-memprofile` ‚Äì –∑–∞–ø–∏—Å—å –∞–ª–ª–æ–∫–∞—Ü–∏–π.

### –ê–Ω–∞–ª–∏–∑ –≤ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–º —Ä–µ–∂–∏–º–µ
```bash
go tool pprof cpu.out
(pprof) top 10   # —Å–∞–º—ã–µ ¬´–∂–∏—Ä–Ω—ã–µ¬ª —Ñ—É–Ω–∫—Ü–∏–∏
(pprof) web      # –æ—Ç–∫—Ä–æ–µ—Ç –≥—Ä–∞—Ñ –≤–æ –≤–Ω–µ—à–Ω–µ–º –±—Ä–∞—É–∑–µ—Ä–µ
```

## 2. –í—Å—Ç—Ä–∞–∏–≤–∞–µ–º pprof –≤ HTTP-—Å–µ—Ä–≤–µ—Ä
```go
import _ "net/http/pprof"

func main() {
    go http.ListenAndServe(":6060", nil) // pprof –ø–æ /debug/pprof
    // rest of app
}
```
–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ <http://localhost:6060/debug/pprof/> –∏ —Å–∫–∞—á–∞–π—Ç–µ `profile`.

## 3. –¢–∏–ø—ã –ø—Ä–æ—Ñ–∏–ª–µ–π
| –§–ª–∞–≥ | –ß—Ç–æ –º–µ—Ä—è–µ—Ç |
|------|------------|
| `profile` | CPU –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30 —Å |
| `heap`    | –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ |
| `goroutine` | –¥–∞–º–ø —Å—Ç–µ–∫–∞ –≤—Å–µ—Ö –≥–æ—Ä—É—Ç–∏–Ω |
| `block`   | –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (Mutex) |
| `trace`   | —Å–æ–±—ã—Ç–∏–π–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ |

## 4. `go tool trace`
```bash
go test -run=^$ -bench=. -trace trace.out
# –∏–ª–∏
curl http://localhost:6060/debug/pprof/trace?seconds=5 > trace.out

go tool trace trace.out
```
–û—Ç–∫—Ä–æ–µ—Ç—Å—è –≤–µ–±-UI —Å —Ç–∞–π–º–ª–∞–π–Ω–æ–º goroutine, —Å–æ–±—ã—Ç–∏—è–º–∏ GC –∏ syscalls.

## 5. –ü—Ä–∞–∫—Ç–∏–∫–∞: —É—Å–∫–æ—Ä—è–µ–º –∞–ª–≥–æ—Ä–∏—Ç–º
1. –ù–∞–ø–∏—à–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø—É–∑—ã—Ä—å–∫–æ–º.  
2. –°–Ω–∏–º–∏—Ç–µ CPU-–ø—Ä–æ—Ñ–∏–ª—å –Ω–∞ 1e5 —ç–ª–µ–º–µ–Ω—Ç–æ–≤.  
3. –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ `sort.Ints` –∏ —Å—Ä–∞–≤–Ω–∏—Ç–µ –≤ `pprof top`.

## –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è üìù
1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ `net/http/pprof` –∫ —Å–≤–æ–µ–º—É –ø—Ä–æ–µ–∫—Ç—É `converter` –∏ —Å–Ω–∏–º–∏—Ç–µ `heap` –ø—Ä–æ—Ñ–∏–ª—å –ø–æ—Å–ª–µ 1000 –∑–∞–ø—Ä–æ—Å–æ–≤. –ì–¥–µ —Ç—Ä–∞—Ç–∏—Ç—Å—è –ø–∞–º—è—Ç—å?  
2. –ò—Å–ø–æ–ª—å–∑—É—è `go tool trace`, –Ω–∞–π–¥–∏—Ç–µ, —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –≤–∞—à–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ–≤–æ–¥–∏—Ç –≤ GC.
