# Профилирование (pprof)

**Профилирование** — это процесс **измерения и анализа производительности программы**. В Go для этого есть встроенный пакет **`pprof`**, который помогает понять, где программа тратит ресурсы и как её ускорить.

---

### Что такое pprof?

* `pprof` позволяет собирать информацию о **CPU, памяти, goroutine и блокировках**.
* Можно создавать **графы вызовов, отчёты и визуализации**, чтобы понять узкие места в коде.
* Используется как для **локальных**, так и для **удалённых** сервисов.

---

### Основные типы профилей

1. **CPU profile**

   * Показывает, какие функции потребляют больше всего процессорного времени.

2. **Heap profile**

   * Анализирует использование памяти (объекты в куче).

3. **Goroutine profile**

   * Информация о текущих goroutine, их количестве и состоянии.

4. **Block profile**

   * Профилирует время блокировок, ожиданий и мьютексов.

5. **Threadcreate profile**

   * Анализирует создание потоков ОС.

---

### Пример использования pprof

Добавим в HTTP-сервер:

```go
package main

import (
    "fmt"
    "net/http"
    _ "net/http/pprof"
)

func main() {
    go func() {
        fmt.Println("pprof running on :6060")
        http.ListenAndServe("localhost:6060", nil)
    }()

    // основной сервер
    http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
        w.Write([]byte("Hello, pprof!"))
    })
    http.ListenAndServe(":8080", nil)
}
```

* После запуска сервера **pprof доступен по `http://localhost:6060/debug/pprof/`**.
* Можно просматривать **`heap`, `goroutine`, `profile`** и строить графы вызовов.

---

### Использование с командной строкой

```bash
# CPU-профиль на 30 секунд
go tool pprof http://localhost:6060/debug/pprof/profile?seconds=30

# Просмотр отчёта
(pprof) top
(pprof) list main.myFunction
(pprof) web  # открывает граф в браузере
```

* `go tool pprof` умеет работать как с локальными файлами, так и с HTTP-профилями.
* Отчёты помогают понять **какие функции тормозят программу и где оптимизировать**.

---

### Итог

* Профилирование с помощью **pprof** — это стандартный способ анализа производительности Go-программ.
* Оно помогает находить **узкие места по CPU, памяти и блокировкам**.
* Использование pprof — первый шаг к **оптимизации и повышению надёжности приложения**.