# 3.7 Scheduler & Tracer

> –†–∞–Ω—Ç–∞–π–º Go –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–æ–¥–µ–ª—å M:N: —Ç—ã—Å—è—á–∏ goroutine (G) –º—É–ª—å—Ç–∏–ø–ª–µ–∫—Å–∏—Ä—É—é—Ç—Å—è –ø–æ–≤–µ—Ä—Ö –ø–æ—Ç–æ–∫–æ–≤ –û–° (M), —É–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–º (P ‚Äì –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã). –ü–æ–Ω–∏–º–∞–Ω–∏–µ —ç—Ç–æ–≥–æ –ø–æ–º–æ–≥–∞–µ—Ç –ª–æ–≤–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏ —Ç—é–Ω–∏–Ω–≥–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.

## 1. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
* **G (goroutine)** ‚Äì —Å—Ç—ç–∫ + –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ.  
* **M (machine)** ‚Äì –ø–æ—Ç–æ–∫ –û–°.  
* **P (processor)** ‚Äì –ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä, –≤–ª–∞–¥–µ–µ—Ç –æ—á–µ—Ä–µ–¥—å—é G. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ P = `GOMAXPROCS`.

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
1. –ì–æ—Ä—É—Ç–∏–Ω–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è ‚Üí –∫–ª–∞–¥—ë—Ç—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –æ—á–µ—Ä–µ–¥—å P.  
2. M, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –∫ P, –±–µ—Ä—ë—Ç G –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç.  
3. –ö–æ–≥–¥–∞ G –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è (syscall, –∫–∞–Ω–∞–ª –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö), M –ø–∞—Ä–∫—É–µ—Ç –µ—ë –∏ –±–µ—Ä—ë—Ç –¥—Ä—É–≥—É—é.  
4. –ï—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞, –∫—Ä–∞–¥—ë—Ç (¬´work stealing¬ª) –∑–∞–¥–∞—á–∏ —É —Å–æ—Å–µ–¥–Ω–∏—Ö P.

## 2. `GOMAXPROCS`
```go
runtime.GOMAXPROCS(0) // –≤–µ—Ä–Ω—É—Ç—å —Ç–µ–∫—É—â–∏–π
runtime.GOMAXPROCS(4) // —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å 4 P
```
–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é = —á–∏—Å–ª—É –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —è–¥–µ—Ä.

## 3. `runtime/trace` ‚Äì –≥–ª—É–±–æ–∫–∞—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞
```go
f, _ := os.Create("trace.out")
runtime/trace.Start(f)
// workload
trace.Stop()

go tool trace trace.out # –≤–µ–±-UI
```
–í–∫–ª–∞–¥–∫–∏: Scheduler, Goroutines, Network, Syscalls.

## 4. –ë–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
B-rich —Ñ—É–Ω–∫—Ü–∏–∏: `time.Sleep`, `log.Output`, syscall. –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Ö ¬´ressched¬ª.

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–¥–µ—Ä–∂–µ–∫ GC vs Syscall
```
(pprof) trace goroutine
```
–ò—â–∏—Ç–µ –¥–æ–ª–≥–∏–µ —Å—Ç—ç–∫–∏.

## 5. –¢—é–Ω–∏–Ω–≥
- –†–∞–∑–±–∏–≤–∞–π—Ç–µ —Ç—è–∂—ë–ª—ã–µ CPU-—Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ –º–µ–ª–∫–∏–µ –∑–∞–¥–∞—á–∏ ‚Üí –±–æ–ª—å—à–µ –∫—Ä–∞—Å—Ç—å.  
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `sync.WaitGroup` –≤–º–µ—Å—Ç–æ `time.Sleep` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.  
- –ù–µ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –º–∏–ª–ª–∏–æ–Ω—ã –≥–æ—Ä—É—Ç–∏–Ω –±–µ–∑ –Ω—É–∂–¥—ã; –ø—É–ª worker –∏–∑ N=GOMAXPROCS*2 –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.

## –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è üìù
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—É —Å 1e5 –≥–æ—Ä—É—Ç–∏–Ω, –∫–∞–∂–¥–∞—è —Å–ø–∏—Ç 10 –º—Å; —Å–Ω–∏–º–∏—Ç–µ `runtime/trace` –∏ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞–≥—Ä—É–∑–∫—É.  
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `GOMAXPROCS=1` –∏ –ø–æ–º–µ—Ä—å—Ç–µ –≤—Ä–µ–º—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ 4√ó1e6 ints vs –∑–Ω–∞—á–µ–Ω–∏–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.  
3. –ò—Å–ø–æ–ª—å–∑—É—è pprof trace, –Ω–∞–π–¥–∏—Ç–µ —Ç–æ–ø-3 –≥–æ—Ä—É—Ç–∏–Ω—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –æ–∂–∏–¥–∞–Ω–∏—è.
