# 3.6 –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã –∏ Observability

> –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å ‚Äî —ç—Ç–æ –º–∞–ª–µ–Ω—å–∫–∏–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å, –æ–±—â–∞—é—â–∏–π—Å—è –ø–æ —Å–µ—Ç–∏. –í–∞–∂–Ω—ã –≥—Ä–∞–Ω–∏—Ü—ã, —Å—Ö–µ–º—ã API –∏ –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å (traces/metrics/logs).

## 1. API Gateway & —Å–µ—Ä–≤–∏—Å—ã
```
[ Front ] -> /api/* ----> gateway
                         |-- user-service :8081
                         |-- order-service :8082
```
–†–æ—É—Ç–∏–Ω–≥ –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å `nginx`, `traefik` –∏–ª–∏ `Envoy`.

### –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `v1/`, `v2/` –≤ URL –∏–ª–∏ gRPC options.

## 2. Observability Stack
| –°–ª–æ–π | –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç |
|------|------------|
| Logs | Loki + Grafana |
| Metrics | Prometheus |
| Traces | OpenTelemetry + Jaeger |

### –ü—Ä–∏–º–µ—Ä –º–µ—Ç—Ä–∏–∫ —Å `promhttp`
```go
import "github.com/prometheus/client_golang/prometheus/promhttp"
http.Handle("/metrics", promhttp.Handler())
```

### Tracing —Å OTEL
```go
tp := tracesdk.NewTracerProvider(tracesdk.WithBatcher(jaegerExporter))
otel.SetTracerProvider(tp)

tr := otel.Tracer("user-service")
ctx, span := tr.Start(ctx, "DB query")
span.End()
```

## 3. Circuit breaker (gobreaker)
```go
cb := gobreaker.NewCircuitBreaker(gobreaker.Settings{})
res, err := cb.Execute(func() (any, error) {
    return http.Get(url)
})
```

## 4. Rate Limiting (golang.org/x/time/rate)
```go
lim := rate.NewLimiter(10, 20) // 10 rps, burst 20
if err := lim.Wait(ctx); err != nil { ... }
```

## 5. Graceful shutdown –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `errgroup.Group` + –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ—Ç–º–µ–Ω—ã.
```go
g, ctx := errgroup.WithContext(context.Background())
servers := []*http.Server{api, metrics}
for _, srv := range servers {
    s := srv
    g.Go(func() error { return s.ListenAndServe() })
}
<-ctx.Done()
for _, s := range servers { s.Shutdown(ctx) }
```

## –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è üìù
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ user-service –∏ order-service, —Å–æ–±–µ—Ä–∏—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –≤ Prometheus –∏ –ø–æ—Å—Ç—Ä–æ–π—Ç–µ –≥—Ä–∞—Ñ QPS.  
2. –î–æ–±–∞–≤—å—Ç–µ tracing OTEL ‚Üí Jaeger; —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–ø–∞–Ω—ã –≤–∏–¥–Ω—ã –≤ UI.  
3. –†–µ–∞–ª–∏–∑—É–π—Ç–µ —Ä–µ—Å–∏–ª–∏–µ–Ω—Ç–Ω—ã–π –∫–ª–∏–µ–Ω—Ç —Å circuit breaker + retry.
