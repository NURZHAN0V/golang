# 3.1 GC internals –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏

> –°–±–æ—Ä—â–∏–∫ –º—É—Å–æ—Ä–∞ (GC) Go ‚Äî –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–Ω—ã–π, —Ç—Ä–∏–∫–æ–ª–æ—Ä–Ω—ã–π, mark-sweep, —Å –ø–∞—É–∑–∞–º–∏ –º–µ–Ω—å—à–µ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã. –ü–æ–Ω–∏–º–∞–Ω–∏–µ –µ–≥–æ —Ä–∞–±–æ—Ç—ã –ø–æ–º–æ–≥–∞–µ—Ç –ø–∏—Å–∞—Ç—å –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –∫–æ–¥.

## 1. –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –æ–±—ä–µ–∫—Ç–∞
1. **Allocation** ‚Äì `new`/`make` –∫–ª–∞–¥—ë—Ç –æ–±—ä–µ–∫—Ç –≤ –∫—É—á—É (heap) –∏–ª–∏ —Å—Ç–µ–∫ (escape analysis).  
2. **Reachability** ‚Äì –µ—Å–ª–∏ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∏, –æ–±—ä–µ–∫—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è ¬´–∂–∏–≤—ã–º¬ª.  
3. **Garbage** ‚Äì –∫–æ–≥–¥–∞ —Å—Å—ã–ª–æ–∫ –Ω–µ—Ç, GC –µ–≥–æ –æ—á–∏—Å—Ç–∏—Ç.

## 2. –§–∞–∑—ã GC (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)
| –§–∞–∑–∞ | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç |
|------|------------|
| Mark  | –û–±—Ö–æ–¥–∏—Ç –≥—Ä–∞—Ñ –æ–±—ä–µ–∫—Ç–æ–≤, –ø–æ–º–µ—á–∞–µ—Ç –¥–æ—Å—Ç–∏–∂–∏–º—ã–µ (—Ü–≤–µ—Ç ¬´—á—ë—Ä–Ω—ã–π¬ª). |
| Sweep | –ü—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ –∫—É—á–µ, –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç ¬´–±–µ–ª—ã–µ¬ª (–Ω–µ–¥–æ—Å—Ç–∏–∂–∏–º—ã–µ). |

–ü—Ä–æ—Ü–µ—Å—Å –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–Ω—ã–π: mark –∏–¥—ë—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –≤–∞—à–∏–º –≥–æ—Ä—É—Ç–∏–Ω–∞–º, –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—è –º–∏—Ä (STW) <1 –º—Å.

## 3. –ü–∞—Ä–∞–º–µ—Ç—Ä GOGC
`GOGC` ‚Äî –ø—Ä–æ—Ü–µ–Ω—Ç —Ä–æ—Å—Ç–∞ –∫—É—á–∏ –¥–æ –∑–∞–ø—É—Å–∫–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ GC. 100 = —É–¥–≤–æ–µ–Ω–∏–µ.  
```bash
GOGC=200 go run main.go # —Ä–µ–∂–µ GC, –±–æ–ª—å—à–µ –ø–∞–º—è—Ç—å
```

### –¢–æ–Ω–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ —Ä–∞–Ω—Ç–∞–π–º–µ
```go
var m debug.GCStats
for {
    debug.ReadGCStats(&m)
    fmt.Println(m.NumGC, m.PauseTotal)
    time.Sleep(time.Second)
}
```

## 4. Escape analysis
`go build -gcflags="-m"` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫—Ç–æ ¬´—É–±–µ–∂–∞–ª¬ª –≤ –∫—É—á—É:
```
x.go:8:6: moved to heap: tmp
```
–°–æ–≤–µ—Ç—ã: –≤–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è, –∞ –Ω–µ —É–∫–∞–∑–∞—Ç–µ–ª–∏, –∏–∑–±–µ–≥–∞–π—Ç–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤, –µ—Å–ª–∏ –º–æ–∂–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–∏–ø.

## 5. Arena API (Go 1.27 draft)
–ü–æ–∑–≤–æ–ª–∏—Ç –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –∞–ª–ª–æ–∫–∞—Ü–∏–∏ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è. –ü–æ–∫–∞ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç.

## 6. –ü—Ä–æ—Ñ–∏–ª–∏ –ø–∞–º—è—Ç–∏
```bash
go test -run=^$ -bench=. -memprofile mem.out
```
`go tool pprof -http=:8080 mem.out` ‚Üí –≤–∫–ª–∞–¥–∫–∞ Inuse Objects.

## 7. –ë—ã—Å—Ç—Ä—ã–µ –ø–æ–±–µ–¥—ã –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ** —Å—Ä–µ–∑—ã: `buf = buf[:0]`.  
- **sync.Pool** –¥–ª—è –∫–æ—Ä–æ—Ç–∫–æ–∂–∏–≤—É—â–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤.  
- **Avoid allocations** –≤–Ω—É—Ç—Ä–∏ –≥–æ—Ä—è—á–∏—Ö —Ü–∏–∫–ª–æ–≤.

## –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è üìù
1. –ù–∞–ø–∏—à–∏—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—É, –∫–æ—Ç–æ—Ä–∞—è –∞–ª–ª–æ—Ü–∏—Ä—É–µ—Ç 1 –º–ª–Ω —Å—Ç—Ä—É–∫—Ç—É—Ä `{int,int}` –∏ –∏–∑–º–µ—Ä—å—Ç–µ `pprof` heap. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –º–∞—Å—Å–∏–≤ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.  
2. –°—Ä–∞–≤–Ω–∏—Ç–µ –≤—Ä–µ–º—è `strings.Builder` vs `+=` –Ω–∞ 50k –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–π –∏ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ GC-–ø–∞—É–∑—ã.  
3. –ü–æ–∏–≥—Ä–∞–π—Ç–µ —Å `GOGC=50` –∏ `GOGC=200`; –∏–∑–º–µ—Ä—å—Ç–µ RSS –ø–∞–º—è—Ç–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ GC.
