# 3.5 Docker –∏ CI/CD

> 90 % Go-—Å–µ—Ä–≤–∏—Å–æ–≤ –¥–µ–ø–ª–æ–∏—Ç—Å—è –∫–∞–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä. –ê GitHub Actions –¥–µ–ª–∞–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π CI –∑–∞ –ø–∞—Ä—É –º–∏–Ω—É—Ç.

## 1. –ë–∞–∑–æ–≤—ã–π Dockerfile
```dockerfile
FROM golang:1.25 AS build
WORKDIR /app
COPY go.mod .
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -o app ./cmd/api

FROM gcr.io/distroless/static:nonroot
WORKDIR /app
COPY --from=build /app/app .
USER nonroot:nonroot
ENTRYPOINT ["/app/app"]
```
- **Multi-stage**: —Å–Ω–∞—á–∞–ª–∞ —Å–æ–±–∏—Ä–∞–µ–º, –ø–æ—Ç–æ–º –∫–ª–∞–¥—ë–º –≤ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑ (‚âà10 –ú–ë).  
- `CGO_ENABLED=0` + distroless = –±–µ–∑ glibc.

–°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫:
```bash
docker build -t myapi .
docker run -p 8080:8080 myapi
```

## 2. –ü–µ—Ä–µ–¥–∞—á–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
```dockerfile
ENV PORT=8080 LOG_LEVEL=info
```
–í —Ä–∞–Ω—Ç–∞–π–º–µ –º–æ–∂–Ω–æ `-e PORT=80`.

## 3. Docker Compose –¥–ª—è –ë–î
`docker-compose.yml`:
```yaml
version: "3"
services:
  db:
    image: postgres:15
    env_file: .env
    ports: ["5432:5432"]
  api:
    build: .
    depends_on: [db]
    environment:
      DB_DSN: postgres://postgres:pass@db/postgres?sslmode=disable
    ports: ["8080:8080"]
```

## 4. GitHub Actions ‚Äî go test + docker push
`.github/workflows/ci.yml`:
```yaml
name: CI
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-go@v4
      with: {go-version: 1.25.x}
    - run: go test ./...
    - run: docker build -t ghcr.io/${{ github.repository }}:${{ github.sha }} .
    - run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u USER --password-stdin
    - run: docker push ghcr.io/${{ github.repository }}:${{ github.sha }}
```

## 5. goreleaser –¥–ª—è –±–∏–Ω–∞—Ä–µ–π
```bash
go install github.com/goreleaser/goreleaser@latest
goreleaser init
```
–ö–æ–Ω—Ñ–∏–≥ `.goreleaser.yaml` –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è; –ø–æ—Å–ª–µ —Ç–µ–≥–∞ `v1.0.0` —ç–∫—à–Ω –≤—ã–ø—É—Å—Ç–∏—Ç —Ä–µ–ª–∏–∑ —Å –±–∏–Ω–∞—Ä–Ω–∏–∫–∞–º–∏ –¥–ª—è Linux/macOS/Windows.

## 6. –ö–∞–Ω–∞—Ä–µ–π–∫–∞ –∏ health check
–í Dockerfile:
```dockerfile
HEALTHCHECK CMD curl -f http://localhost:8080/health || exit 1
```
Kubernetes —Å–Ω–∏–º–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ 200.

## –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è üìù
1. –°–¥–µ–ª–∞–π—Ç–µ multi-stage Dockerfile –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ `converter`; –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä –æ–±—Ä–∞–∑–∞.  
2. –î–æ–±–∞–≤—å—Ç–µ job `staticcheck` –≤ GitHub Actions –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π.  
3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ `goreleaser` –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ tar.gz –Ω–∞ GitHub Releases.
