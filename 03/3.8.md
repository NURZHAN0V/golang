# 3.8 Production best practices (graceful shutdown, rate limiting)

> –ß–µ–∫-–ª–∏—Å—Ç –≤–µ—â–µ–π, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç—è—Ç —É–≤–∏–¥–µ—Ç—å DevOps –∏ SRE –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º Go-—Å–µ—Ä–≤–∏—Å–∞ –≤ –ø—Ä–æ–¥.

## 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ env + flags
```go
var cfg struct {
    Port int
    Log  string
}
flag.IntVar(&cfg.Port, "port", getEnvInt("PORT", 8080), "http port")
flag.Parse()
```

## 2. Graceful shutdown
```go
srv := &http.Server{Addr: fmt.Sprintf(":%d", cfg.Port)}
ctx, stop := signal.NotifyContext(context.Background(), os.Interrupt)
go srv.ListenAndServe()
<-ctx.Done()
stop()
_ = srv.Shutdown(context.Background())
```
–°–Ω–∏–º–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞ 5‚Äì10 —Å–µ–∫—É–Ω–¥, –Ω–µ —Ç–µ—Ä—è—è –∑–∞–ø—Ä–æ—Å—ã.

## 3. Health / Readiness endpoints
```
GET /health ‚Üí 200 OK  (–∂–∏–≤?)
GET /ready  ‚Üí 200/503 (–≥–æ—Ç–æ–≤ –∫ —Ç—Ä–∞—Ñ–∏–∫—É?)
```
Kubernetes –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏—Ö –¥–ª—è probes.

## 4. Timeouts –∏ –ª–∏–º–∏—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
* HTTP client `Timeout: 10s`.  
* DB `context.WithTimeout(ctx, 2*time.Second)`.  
* `http.Server{ReadHeaderTimeout: 5s, IdleTimeout: 30s}`.

## 5. Rate limiting –∏ middleware order
1. Recover ‚Üí 2. RequestID ‚Üí 3. Logger ‚Üí 4. RateLimit ‚Üí 5. Business.

## 6. Panic ‚Üí recover + alert
```go
defer func(){
  if r:=recover(); r!=nil {
     slog.Error("panic", "err", r, "stack", string(debug.Stack()))
  }
}()
```
–û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –∞–ª–µ—Ä—Ç —á–µ—Ä–µ–∑ Sentry / Grafana OnCall.

## 7. CI gates
- `go vet`, `staticcheck` clean.  
- `go test -race` –ø—Ä–æ—Ö–æ–¥–∏—Ç.  
- Coverage ‚â• 80 %.  
- Image scan Trivy no HIGH/Critical.

## 8. Observability baseline
- **Metrics**: HTTP latency, error rate, goroutines, GC pause.  
- **Logs**: JSON, –ø–æ–ª–µ `trace_id`.  
- **Traces**: –∫–∞–∂–¥–æ–º—É –≤—Ö–æ–¥—è—â–µ–º—É –∑–∞–ø—Ä–æ—Å—É ‚Äî span.

## 9. Security
- `govulncheck` clean.  
- Secret-scanner (gitleaks) –≤ CI.  
- TLS 1.2+, mTLS –≤–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞.

## 10. Deployment checklist
- Version via `-ldflags "-X main.version=$(git sha)"`.  
- Docker label `org.opencontainers.image.revision`.  
- Helm chart with resources requests/limits.

## –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è üìù
1. –î–æ–±–∞–≤—å—Ç–µ graceful shutdown –∏ `/health` –≤ –ø—Ä–æ–µ–∫—Ç `converter`.  
2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ `ulimit -n 10000` –≤ Dockerfile –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –≤—ã–¥–µ—Ä–∂–∏–≤–∞–µ—Ç 5k concurrent connections.
