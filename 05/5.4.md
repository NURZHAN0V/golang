# defer, panic и recover

В Go есть специальная система **управления выполнением и обработкой ошибок**, которая помогает безопасно закрывать ресурсы и реагировать на критические ситуации. Основные инструменты — это **`defer`**, **`panic`** и **`recover`**.

---

### defer — отложенное выполнение

* Ключевое слово `defer` позволяет **отложить выполнение функции до завершения текущей функции**:

```go
func main() {
    defer fmt.Println("Отложенное сообщение")
    fmt.Println("Первое сообщение")
}
```

* Вывод будет такой:

```
Первое сообщение
Отложенное сообщение
```

* `defer` часто используется для **освобождения ресурсов**, например, закрытия файлов или соединений с базой данных:

```go
file, _ := os.Open("example.txt")
defer file.Close() // файл закроется в конце функции
```

* Все отложенные вызовы выполняются **в обратном порядке**:

```go
func main() {
    defer fmt.Println(1)
    defer fmt.Println(2)
    defer fmt.Println(3)
}
```

Вывод:

```
3
2
1
```

---

### panic — критическая ошибка

* `panic` останавливает нормальное выполнение программы и начинает **процесс «паники»**:

```go
func main() {
    panic("Что-то пошло не так!")
    fmt.Println("Эта строка не выполнится")
}
```

* Паника передаёт управление вверх по стеку вызовов, выполняя все отложенные `defer`.
* Обычно `panic` используется для **неожиданных ошибок**, от которых нельзя просто «отскочить».

---

### recover — восстановление после паники

* `recover` позволяет **поймать панику внутри отложенной функции** и продолжить выполнение программы:

```go
func main() {
    defer func() {
        if r := recover(); r != nil {
            fmt.Println("Восстановились после паники:", r)
        }
    }()

    panic("Критическая ошибка")
    fmt.Println("Эта строка выполнится после recover")
}
```

Вывод:

```
Восстановились после паники: Критическая ошибка
```

* `recover` работает **только внутри функции, вызванной через `defer`**.

---

### Типичный сценарий использования

1. `defer` — закрытие файлов, сетевых соединений, освобождение ресурсов.
2. `panic` — неожиданная, критическая ошибка, которую нельзя обработать обычным способом.
3. `recover` — безопасное восстановление после паники для продолжения работы программы или логирования ошибки.

---

### Итого

* **`defer`** — откладывает выполнение функции до выхода из текущей.
* **`panic`** — инициирует критическую ошибку, прерывая выполнение.
* **`recover`** — позволяет поймать панику и восстановить работу программы.
* Вместе они образуют **мощный механизм управления ресурсами и ошибками**, который помогает писать безопасный и устойчивый код на Go.