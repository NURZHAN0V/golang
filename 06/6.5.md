# Context: управление временем жизни

В Go **`context`** — это инструмент для **управления временем жизни горутин и операций**, особенно полезный при работе с **сетевыми запросами, базами данных и таймаутами**.

Он позволяет **отменять операции, передавать дедлайны и значения через цепочку вызовов**.

---

### Что такое `context`

* `context.Context` — это **контейнер для информации о выполнении**:

  * дедлайны (`deadline`)
  * таймауты (`timeout`)
  * сигнал об отмене (`cancel`)
  * произвольные значения (ключ-значение)

* Он используется **для координации работы нескольких горутин**, чтобы избежать "зависших" операций.

---

### Создание контекста

1. **Базовый контекст**:

```go
ctx := context.Background() // пустой корневой контекст
```

2. **Контекст с отменой**:

```go
ctx, cancel := context.WithCancel(context.Background())
defer cancel() // важно вызвать cancel, чтобы освободить ресурсы
```

* `cancel()` сигнализирует всем горутинам, использующим этот контекст, что нужно завершиться.

3. **Контекст с таймаутом**:

```go
ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
defer cancel()
```

* Через 2 секунды контекст автоматически отменяется.

---

### Использование контекста в горутинах

* Горутину можно заставить **следить за контекстом** и завершаться при отмене:

```go
func worker(ctx context.Context) {
    for {
        select {
        case <-ctx.Done():
            fmt.Println("Горутина завершена:", ctx.Err())
            return
        default:
            fmt.Println("Работаем...")
            time.Sleep(500 * time.Millisecond)
        }
    }
}

func main() {
    ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
    defer cancel()
    go worker(ctx)

    time.Sleep(3 * time.Second)
    fmt.Println("Main завершает работу")
}
```

* Вывод: через 2 секунды горутина получит сигнал отмены и завершится.

---

### Передача значений через контекст

* Контекст позволяет передавать **небольшие данные** через цепочку функций:

```go
ctx := context.WithValue(context.Background(), "userID", 42)

func printUserID(ctx context.Context) {
    if v := ctx.Value("userID"); v != nil {
        fmt.Println("User ID:", v)
    }
}

printUserID(ctx)
```

* **Важно:** контекст не предназначен для передачи больших данных, только для служебной информации.

---

### Итого

* **`context`** управляет временем жизни операций и горутин.
* Поддерживает **отмену, таймауты и дедлайны**.
* Позволяет **передавать значения через цепочку вызовов**.
* Используется в **сетевых приложениях, API, базах данных**, чтобы безопасно завершать долгие операции и освобождать ресурсы.