# database/sql

Работа с базами данных — важная часть разработки. В Go для этого есть стандартный пакет **`database/sql`**, который предоставляет единый интерфейс для работы с разными СУБД (PostgreSQL, MySQL, SQLite и др.).

Сам пакет не умеет напрямую подключаться к базе — для этого используются **драйверы**, которые реализуют интерфейс `database/sql/driver`.

---

### Подключение к базе

Для начала нужно импортировать драйвер, например PostgreSQL:

```go
import (
    "database/sql"
    _ "github.com/lib/pq"
)
```

* Символ `_` означает, что пакет импортируется ради **побочного эффекта** — он регистрирует драйвер, но напрямую мы его не вызываем.

Далее создаём подключение:

```go
db, err := sql.Open("postgres", "user=postgres password=1234 dbname=test sslmode=disable")
if err != nil {
    panic(err)
}
defer db.Close()
```

* `sql.Open` не устанавливает подключение сразу, а лишь создаёт объект доступа к базе.
* Фактическое соединение устанавливается при первом запросе.

---

### Выполнение запросов

1. **Простой запрос без результата** (`INSERT`, `UPDATE`, `DELETE`):

```go
_, err = db.Exec("INSERT INTO users (name, age) VALUES ($1, $2)", "Олег", 25)
if err != nil {
    panic(err)
}
```

2. **Запрос с одной строкой результата** (`SELECT ... WHERE`):

```go
var name string
err = db.QueryRow("SELECT name FROM users WHERE id=$1", 1).Scan(&name)
if err != nil {
    panic(err)
}
fmt.Println("Имя:", name)
```

3. **Запрос с несколькими строками**:

```go
rows, err := db.Query("SELECT id, name FROM users")
if err != nil {
    panic(err)
}
defer rows.Close()

for rows.Next() {
    var id int
    var name string
    rows.Scan(&id, &name)
    fmt.Println(id, name)
}
```

---

### Подготовленные выражения

Чтобы не повторять запросы и защититься от SQL-инъекций, удобно использовать **prepared statements**:

```go
stmt, err := db.Prepare("INSERT INTO users (name, age) VALUES ($1, $2)")
if err != nil {
    panic(err)
}
defer stmt.Close()

_, err = stmt.Exec("Анна", 30)
_, err = stmt.Exec("Игорь", 22)
```

---

### Пулы соединений

`database/sql` автоматически управляет **пулом подключений**. Можно настроить:

```go
db.SetMaxOpenConns(10) // макс. число открытых соединений
db.SetMaxIdleConns(5)  // макс. число "спящих" соединений
db.SetConnMaxLifetime(time.Hour) // время жизни соединения
```

Это важно для производительности в реальных приложениях.

---

### Итого

* `database/sql` — стандартный способ работы с базами в Go.
* Требует использования драйверов (`pq`, `mysql`, `sqlite3` и др.).
* Поддерживает **Exec, QueryRow, Query**, подготовленные выражения и пул соединений.
* Подходит для гибкой и быстрой работы с SQL-базами.