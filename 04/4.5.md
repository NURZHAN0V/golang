# Финальный проект 🔬 Микросервисный набор (Auth + Billing + API-Gateway)

## Цель
Собрать мини-продукт из трёх микросервисов, связанных gRPC + REST-gateway, с полным наблюдением, CI/CD и Docker-Compose.

## 1. Сервисы
| Имя | Порт | Ответственность |
|-----|------|-----------------|
| auth-svc    | 50051 | регистрация, JWT-логин |
| billing-svc | 50052 | кошелёк пользователя, списания |
| gateway     | 8080  | REST ↔ gRPC proxy, статичные файлы |

## 2. Технологии
* gRPC + protobuf + buf.  
* PostgreSQL для auth, billing.  
* Redis для сессий.  
* OpenTelemetry → Jaeger, Prometheus, Grafana.  
* JWT auth, middleware на gateway.  
* CI: GitHub Actions → docker push → deploy локально через docker-compose.

## 3. Репозиторий
```
project/
 ├─ proto/             # *.proto схемы
 ├─ auth-svc/
 │    ├─ cmd/server/main.go
 │    ├─ internal/..
 ├─ billing-svc/
 │    └─ ...
 ├─ gateway/
 │    └─ ...
 ├─ deploy/docker-compose.yml
 └─ go.work
```
Модули объединены через `go work`.

## 4. Auth-service ключевые моменты
* `/Register` – создает пользователя, хэшит пароль `bcrypt`.  
* `/Login` – проверка и выдача `access`+`refresh` JWT.  
* Публикует Prometheus метрики `auth_register_total`.

## 5. Billing-service
* Таблица `transactions` (id, user_id, amount, ts).  
* Method `Charge(user, amt)` с идемпотентным ключом.  
* Emits OTEL trace span `billing.charge`.

## 6. Gateway
* gRPC-gateway генерация (`grpc-ecosystem/grpc-gateway/v2`).  
* Middleware цепочка: recover → cors → logger → auth(JWT verify) → handler.  
* Статичные React-файлы раздаются с `/app/*` (build не описан).

## 7. Observability stack (compose)
```
prometheus:
  image: prom/prometheus
jaeger:
  image: jaegertracing/all-in-one
loki:
  image: grafana/loki
```
Сервисы пишут logs в stdout JSON, собранные Loki-driverом.

## 8. CI/CD кратко
1. Job `test` – `go test ./... -race`.  
2. Job `docker` – buildx matrix (auth, billing, gateway).  
3. Job `deploy` – `docker compose pull && docker compose up -d` через SSH-runner.

## 9. Roadmap улучшений
- k8s Helm-чарты.  
- Saga-паттерн между сервисами.  
- Rate-limit per-user в gateway.  
- GraphQL-шлюз поверх gRPC.

## Задания для читателя 📝
1. Добавьте сервис `email-svc`, отправляющий письма через SMTP mock, и интегрируйте его в процесс регистрации.  
2. Реализуйте refund в billing-svc с проверкой достатка средств.  
3. Настройте alert в Prometheus: `billing_charge_error_rate > 5%`.
