# –ü—Ä–æ–µ–∫—Ç üî¨ gRPC-—á–∞—Ç + WebSocket Gateway

## –¶–µ–ª—å
–°–æ–∑–¥–∞—Ç—å –º–∏–Ω–∏-—á–∞—Ç, –≥–¥–µ –º–æ–±–∏–ª—å–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã –æ–±—â–∞—é—Ç—Å—è –ø–æ gRPC, –∞ –≤–µ–±-–±—Ä–∞—É–∑–µ—Ä –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ WebSocket —á–µ—Ä–µ–∑ gRPC-Gateway.

## 1. –ü—Ä–æ—Ç–æ–∫–æ–ª messages.proto
```proto
syntax = "proto3";
package chat;
option go_package = "example.com/chat/api";

service Chat {
  rpc Stream (stream Message) returns (stream Message);
}

message Message {
  string user = 1;
  string text = 2;
  int64  ts   = 3;
}
```
–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∫–æ–¥:
```bash
protoc --go_out=. --go-grpc_out=. messages.proto
```

## 2. –°–µ—Ä–≤–µ—Ä-—Ö–∞–±
```go
type hub struct {
    chat.UnimplementedChatServer
    mu     sync.Mutex
    conns  map[string]chat.Chat_StreamServer // –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
}

func (h *hub) Stream(s chat.Chat_StreamServer) error {
    first, _ := s.Recv()               // –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–º—è
    user := first.User

    h.mu.Lock(); h.conns[user] = s; h.mu.Unlock()

    for {
        msg, err := s.Recv()
        if err != nil { break }
        h.broadcast(msg)
    }
    return nil
}

func (h *hub) broadcast(m *chat.Message) {
    h.mu.Lock(); defer h.mu.Unlock()
    for u, c := range h.conns {
        if u == m.User { continue }
        _ = c.Send(m)
    }
}
```

## 3. gRPC-Gateway
```bash
go install github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-grpc-gateway@latest
protoc --grpc-gateway_out=. --grpc-gateway_opt logtostderr=true messages.proto
```
`mux := runtime.NewServeMux()` –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç `ws://host/v1/chat/stream` –∫ gRPC.

### WebSocket endpoint
```js
const ws = new WebSocket("ws://localhost:8080/v1/chat/stream");
ws.onmessage = e => console.log(JSON.parse(e.data));
ws.onopen = () => ws.send(JSON.stringify({user:"web", text:"hi", ts:Date.now()}));
```

## 4. Docker-Compose
```
services:
  chat:
    build: .
    ports: ["8080:8080", "50051:50051"]
```

## 5. –¢–µ—Å—Ç—ã
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `bufconn` –¥–ª—è in-mem gRPC, –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ, —á—Ç–æ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–¥–Ω–æ–º—É –∫–ª–∏–µ–Ω—Ç—É, –≤—Ç–æ—Ä–æ–π –ø–æ–ª—É—á–∞–µ—Ç.

## –£–ª—É—á—à–µ–Ω–∏—è
* auth-middleware: —Ç–æ–∫–µ–Ω –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö gRPC, JWT –¥–ª—è –≤–µ–±–∞.  
* —Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤ Redis pub/sub.  
* –¥–æ–±–∞–≤–∏—Ç—å Prometheus –º–µ—Ç—Ä–∏–∫–∏ active_users.

## –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è üìù
1. –î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É `/me is typing‚Ä¶` ‚Äì —Ä–∞—Å—Å—ã–ª–∞–π—Ç–µ event, –Ω–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –≤ –∏—Å—Ç–æ—Ä–∏–∏.  
2. –†–µ–∞–ª–∏–∑—É–π—Ç–µ reconnect: –∫–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∏ –ø–æ–ª—É—á–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π.  
3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ TLS –º–µ–∂–¥—É gateway –∏ gRPC-—Å–µ—Ä–≤–µ—Ä–æ–º, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ self-signed cert.
