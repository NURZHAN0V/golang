# 1.11 `sync` –∏ `context`

## 1. –ü–∞–∫–µ—Ç `sync`

### 1.1 `WaitGroup` ‚Äì –∂–¥—ë–º –≥–æ—Ä—É—Ç–∏–Ω—ã
```go
var wg sync.WaitGroup
for i := 0; i < 3; i++ {
    wg.Add(1)
    go func(id int) {
        defer wg.Done()
        time.Sleep(time.Second)
        fmt.Println("done", id)
    }(i)
}
wg.Wait()
```

### 1.2 –ú—å—é—Ç–µ–∫—Å
```go
var mu sync.Mutex
balance := 0
add := func(n int) {
    mu.Lock()
    balance += n
    mu.Unlock()
}
```
*–ù–µ* –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `Mutex` –¥–ª—è –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —Å—á—ë—Ç—á–∏–∫–æ–≤ ‚Äî –≤–æ–∑—å–º–∏—Ç–µ `sync/atomic`.

### 1.3 `sync.Once`
```go
var once sync.Once
once.Do(initConfig)
```
`initConfig` –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑.

### 1.4 `sync.Map`
–ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∫–∞—Ä—Ç–∞ (—á–µ—Å—Ç–Ω–æ –ø—Ä–∏–≥–æ–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—á–µ–Ω—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ high-concurrency).

```go
var m sync.Map
m.Store("foo", 42)
if v, ok := m.Load("foo"); ok {
    fmt.Println(v)
}
```

---

## 2. –ö–æ–Ω—Ç–µ–∫—Å—Ç (`context`)
`context.Context` –Ω–µ—Å—ë—Ç –¥–µ–¥–ª–∞–π–Ω, —Ç–∞–π–º–∞—É—Ç, –∫–∞–Ω–∞–ª –æ—Ç–º–µ–Ω—ã –∏ values –¥–ª—è request-scope.

### 2.1 –°–æ–∑–¥–∞–Ω–∏–µ
```go
ctx := context.Background()           // –∫–æ—Ä–Ω–µ–≤–æ–π
ctx, cancel := context.WithTimeout(ctx, 2*time.Second)
defer cancel()
```

### 2.2 –ü–µ—Ä–µ–¥–∞—á–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏
```go
func fetch(ctx context.Context, url string) ([]byte, error) {
    req, _ := http.NewRequestWithContext(ctx, http.MethodGet, url, nil)
    resp, err := http.DefaultClient.Do(req)
    if err != nil {
        return nil, err
    }
    defer resp.Body.Close()
    return io.ReadAll(resp.Body)
}
```
–ï—Å–ª–∏ –¥–µ–¥–ª–∞–π–Ω –≤—ã–π–¥–µ—Ç —Ä–∞–Ω—å—à–µ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞, –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∞—Å—Ç –æ—à–∏–±–∫—É `context deadline exceeded`.

### 2.3 –û—Ç–º–µ–Ω–∞ –ø–æ –∫–∞—Å—Ç–æ–º–Ω–æ–º—É —Å–æ–±—ã—Ç–∏—é
```go
ctx, cancel := context.WithCancel(context.Background())
go func() {
    time.Sleep(time.Second)
    cancel() // –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ, –∫—Ç–æ —Å–ª—É—à–∞–µ—Ç ctx
}()

select {
case <-ctx.Done():
    fmt.Println("stopped:", ctx.Err())
}
```

### 2.4 –ü–µ—Ä–µ–¥–∞—á–∞ –∑–Ω–∞—á–µ–Ω–∏–π
```go
type key string
ctx := context.WithValue(context.Background(), key("uid"), 123)
userID := ctx.Value(key("uid")).(int)
```
> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `WithValue` **—Ç–æ–ª—å–∫–æ** –¥–ª—è —Å–∫–≤–æ–∑–Ω—ã—Ö –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (trace-id), –Ω–µ –¥–ª—è –±–∏–∑–Ω–µ—Å –¥–∞–Ω–Ω—ã—Ö.

---

## –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è üìù
1. –ù–∞–ø–∏—à–∏—Ç–µ —Å—á—ë—Ç—á–∏–∫ —Å `sync.Mutex` –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ 100 –≥–æ—Ä—É—Ç–∏–Ω, –∫–∞–∂–¥–∞—è —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —á–∏—Å–ª–æ –Ω–∞ 1; –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Ç–æ–≥.  
2. –†–µ–∞–ª–∏–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `parallelSum(ctx context.Context, nums []int) (int, error)`; –¥–æ–ª–∂–Ω–∞ –¥–µ–ª–∏—Ç—å —Ä–∞–±–æ—Ç—É –Ω–∞ –≥–æ—Ä—É—Ç–∏–Ω—ã –∏ —É–≤–∞–∂–∞—Ç—å –æ—Ç–º–µ–Ω—É –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.  
3. –ò—Å–ø–æ–ª—å–∑—É—è `sync.Once`, —Å–¥–µ–ª–∞–π—Ç–µ –ª–µ–Ω–∏–≤—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –¥–≤—É–º–µ—Ä–Ω–æ–≥–æ —Å–ª–∞–π—Å–∞ (–∫–µ—à).
